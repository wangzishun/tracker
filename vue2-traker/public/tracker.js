!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory((global="undefined"!=typeof globalThis?globalThis:global||self).tracker={})}(this,(function(exports){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)Object.prototype.hasOwnProperty.call(b,p)&&(d[p]=b[p])})(d,b)};function __extends(d,b){if("function"!=typeof b&&null!==b)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)};function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))}function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __spreadArrays(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;var r=Array(s),k=0;for(i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r}var WMDAParamsEnum={Key:"event_id",EventId:"event_id"},SOJParamsEnum={Key:"action",Action:"action",Site:"site",Plat:"plat",Type:"type"},ToolsTrackingUniqueKeys={Common:"Key",WMDA:"EventId",SOJ:"Action"},WMDAParamsEnumKeys=Object.keys(WMDAParamsEnum),SOJParamsEnumKeys=Object.keys(SOJParamsEnum);function isUndefined(value){return void 0===value}function isString(value){return"string"==typeof value}var BaseTag_async="[object AsyncFunction]",BaseTag_func="[object Function]";function isFunction(value){var tag=Object.prototype.toString.call(value);return tag===BaseTag_async||tag===BaseTag_func}var BaseTracker=function(){function BaseTracker(){}return BaseTracker.prototype.send=function(params){if(isUndefined(this.sender)&&(this.sender=console.log),isUndefined(this.serializeData))throw new Error("需要实现 serializeData 方法");var serializeData=this.serializeData(params);this.sender(serializeData)},BaseTracker}(),map=new Map,TimeSpan=function(_super){function TimeSpan(){var _this=_super.call(this)||this;return _this.span=(new Date).getTime(),_this}return __extends(TimeSpan,_super),TimeSpan.prototype.getSpan=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.sleepDebouncing(666)];case 1:return _a.sent(),this.span=(new Date).getTime()-this.span,this.span>716?[2,this.span]:[2]}}))}))},TimeSpan}(function(){function TimeSpanBase(){}return TimeSpanBase.prototype.sleepDebouncing=function(interval){var _this=this;return this.clearTimeout(),new Promise((function(resolve){_this.timer=setTimeout((function(){resolve(_this.timer),_this.clearTimeout()}),interval)}))},TimeSpanBase.prototype.clearTimeout=function(){clearTimeout(this.timer),this.timer=null},TimeSpanBase}()),timeSpanPatch=function(params){return __awaiter(void 0,void 0,void 0,(function(){var key,timeSpan,span;return __generator(this,(function(_a){switch(_a.label){case 0:return key=function(params){var toolsTrackingCertificate=Object.values(ToolsTrackingUniqueKeys).reduce((function(previouse,uniqueKeys){return previouse[uniqueKeys]=params[uniqueKeys],previouse}),{});return JSON.stringify(toolsTrackingCertificate)}(params),isUndefined(timeSpan=map.get(key))&&(timeSpan=new TimeSpan,map.set(key,timeSpan)),[4,timeSpan.getSpan()];case 1:return span=_a.sent(),map.delete(key),span?[2,{timeSpan:span}]:[2]}}))}))};function patches(params,options){return __awaiter(this,void 0,void 0,(function(){var result,error_1;return __generator(this,(function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),[4,Promise.all([timeSpanPatch(params)])];case 1:return result=_a.sent(),[2,Object.assign.apply(Object,__spreadArrays([{},params],result))];case 2:return error_1=_a.sent(),console.error("[tracker] tracker patch error.. ",error_1),[3,3];case 3:return[2]}}))}))}var SOJTracker=function(_super){function SOJTracker(options){void 0===options&&(options={});var _this=_super.call(this)||this;_this.cachedExtendParameters=options;var SOJ=window.logger||window.loggerAction;if(!isUndefined(SOJ))return _this.sender=function(eventData){return SOJ.sendpv(eventData)},_this}return __extends(SOJTracker,_super),SOJTracker.prototype.serializeData=function(params){for(var SOJEventData={},_i=0,SOJParamsEnumKeys_1=SOJParamsEnumKeys;_i<SOJParamsEnumKeys_1.length;_i++){var key=SOJParamsEnumKeys_1[_i],trackParamKey=SOJParamsEnum[key],trackParamValue=params[key];isUndefined(trackParamValue)||(SOJEventData[trackParamKey]=trackParamValue)}return SOJEventData.ep=__assign(__assign({},this.cachedExtendParameters),params),SOJEventData},SOJTracker}(BaseTracker),WMDATracker=function(_super){function WMDATracker(options){void 0===options&&(options={});var _this=_super.call(this)||this;if(_this.cachedExtendParameters=options,!isUndefined(window.WMDA_REPORT))return _this.sender=function(eventData){return window.WMDA_REPORT("custom",eventData)},_this}return __extends(WMDATracker,_super),WMDATracker.prototype.serializeData=function(params){for(var WMDAEventData={},_i=0,WMDAParamsEnumKeys_1=WMDAParamsEnumKeys;_i<WMDAParamsEnumKeys_1.length;_i++){var key=WMDAParamsEnumKeys_1[_i],trackParamKey=WMDAParamsEnum[key],trackParamValue=params[key];isUndefined(trackParamValue)||(WMDAEventData[trackParamKey]=trackParamValue)}var extendParameters=__assign(__assign({},params),this.cachedExtendParameters);return Object.assign({},WMDAEventData,extendParameters)},WMDATracker}(BaseTracker),trackerForAntdvForm=function(formContext,onValuesChange){var fieldsStore=formContext.fieldsStore,formWatcher=new(0,formContext.$options._base)({data:function(){return{fieldsStore:fieldsStore,unwatchMap:new Map}},beforeDestroy:function(){this.unwatchMap.forEach((function(unwatch){return unwatch()}))}});return formWatcher.$watch("fieldsStore.fields",(function(newestFields){var _this=this,addedFields=[];for(var name_1 in newestFields)Object.prototype.hasOwnProperty.call(newestFields,name_1)&&(this.unwatchMap.has(name_1)||addedFields.push(name_1));0!==addedFields.length&&addedFields.forEach((function(name){var unwatch=formWatcher.$watch((function(){return this.fieldsStore.fields[name].value}),(function(newVal,oldVal){return onValuesChange(name,newVal,oldVal)}),{immediate:!0});_this.unwatchMap.set(name,unwatch)}))})),formWatcher};trackerForAntdvForm.isAntdvForm=function(form){return!0===form._isVue&&!isUndefined(form.fieldsStore)&&!isUndefined(form.formItems)};var Tracker=function(){function Tracker(trackerProps){isUndefined(Tracker.WMDATracker)&&(Tracker.WMDATracker=new WMDATracker(trackerProps)),isUndefined(Tracker.SOJTracker)&&(Tracker.SOJTracker=new SOJTracker(trackerProps))}return Tracker.send=function(params){for(var options=[],_i=1;_i<arguments.length;_i++)options[_i-1]=arguments[_i];return __awaiter(this,void 0,void 0,(function(){var data;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,patches(isString(params)?{key:params}:params)];case 1:return data=_a.sent(),new Tracker,Tracker.WMDATracker&&Tracker.WMDATracker.send(data),Tracker.SOJTracker&&Tracker.SOJTracker.send(data),[2]}}))}))},Tracker.track=function(params){return function(target,propertyKey,descriptor){return isUndefined(propertyKey)&&isUndefined(descriptor)?TrackClass(params):TrackClassMethod(params,descriptor)}},Tracker.form=function(context,options){try{trackForm(context,options)}catch(error){console.log(error)}},Tracker}();function TrackClassMethod(params,descriptor){var originalValue=descriptor.value;return descriptor.value=function(){var _this=this,args=arguments,result=originalValue.apply(this,args),tracking=function(originalValueResult){return __awaiter(_this,void 0,void 0,(function(){var AspectFunctionResult;return __generator(this,(function(_a){switch(_a.label){case 0:return isFunction(params)?[4,params.apply(this,[args,originalValueResult])]:[3,2];case 1:return AspectFunctionResult=_a.sent(),Tracker.send(AspectFunctionResult),[3,3];case 2:Tracker.send(params),_a.label=3;case 3:return[2]}}))}))};return result instanceof Promise?result.then(tracking):tracking(result),result},descriptor}function TrackClass(params,target){console.log(params)}function trackForm(context,options){void 0===options&&(options={});var fieldsMapping=options.fieldsMapping,onValuesChange=options.onValuesChange;if(trackerForAntdvForm.isAntdvForm(context)){var handleChange=function(fieldsMapping,onValuesChange){return function(fieldsName,fieldsValue,oldVal){var params=isFunction(onValuesChange)?onValuesChange(fieldsName,fieldsValue,oldVal):{},Key=fieldsMapping[fieldsName];Tracker.send(__assign({Key:Key,fieldsName:fieldsName,fieldsValue:fieldsValue},params))}}(fieldsMapping,onValuesChange);trackerForAntdvForm(context,handleChange)}}window.Tracker=Tracker,exports.TrackClass=TrackClass,exports.TrackClassMethod=TrackClassMethod,exports.Tracker=Tracker,exports.default=Tracker,exports.trackForm=trackForm,exports.trackerForAntdvForm=trackerForAntdvForm,Object.defineProperty(exports,"__esModule",{value:!0})}));
